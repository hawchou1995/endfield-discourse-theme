<style>
  /* ===================================================
     1. åå®¢ä¸ºä¸»ï¼šå¤ºèˆ Discourse åŸç”Ÿé¢„åŠ è½½å±
     =================================================== */
  /* å°†åŸç”ŸåŠ è½½å±ç›´æ¥ä¼ªè£…æˆç»ˆæœ«åœ°èƒŒæ™¯ï¼Œå¡«è¡¥ JS å»¶è¿ŸåŠ è½½æ—¶çš„ç™½å±ç©ºç™½ */
  #d-splash {
    background-color: #12151A !important;
    background-image:
      linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px),
      linear-gradient(180deg, rgba(255,255,255,0.03) 1px, transparent 1px) !important;
    background-size: 40px 40px !important;
    z-index: 9999998 !important; 
  }
  /* ç‰©ç†è¶…åº¦åŸç”Ÿå±é‡Œçš„ 5 ä¸ªç´«è‰²ç‚¹å’Œé¢„åŠ è½½å›¾ */
  #d-splash .dots, 
  #d-splash .preloader-image {
    display: none !important;
    opacity: 0 !important;
    animation: none !important;
  }

  /* ===================================================
     2. å¸¸è§„å†…éƒ¨åŠ è½½åœˆæ‹¦æˆª (åŒä¿é™©)
     =================================================== */
  #main-outlet > .spinner, 
  #main-outlet.wrap > .spinner, 
  #main-outlet-wrapper > .spinner,
  #main > .spinner,
  body > .spinner,
  .d-app-body > .spinner,
  #discourse-root > .spinner,
  .fallback-spinner, 
  .route-spinner,
  .global-spinner,
  #global-spinner,
  .spinner-container { 
    display: none !important; 
    opacity: 0 !important;
    visibility: hidden !important;
  }

  /* ===================================================
     3. ç»ˆæœ«åœ°ä¸“å±åŠ è½½ç•Œé¢ (Endfield Loader)
     =================================================== */
  #endfield-loader {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    background-color: #12151A !important; 
    background-image:
      linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px),
      linear-gradient(180deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    z-index: 9999999;
    transition: opacity 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
    font-family: "Rajdhani", "JetBrains Mono", sans-serif;
    overflow: visible; 
  }

  :root{
    --sat: env(safe-area-inset-top, 0px);
    --sab: env(safe-area-inset-bottom, 0px);
  }

  /* è½¬åœºå¹•å¸ƒï¼šä»å·¦ä¾§é”šå®šï¼Œåˆå§‹å®½åº¦ä¸º0 */
  #ef-orange-flash {
    position: absolute; inset: 0;
    background-color: #FF6B35;
    z-index: 10;
    pointer-events: none;
    transform-origin: left center; /* é”šå®šå·¦è¾¹ç¼˜ */
    transform: scaleX(0);          /* åˆå§‹ X è½´ç¼©æ”¾ä¸º 0 */
    transition: transform 0.25s cubic-bezier(0.22, 0.61, 0.36, 1); /* æ¸…è„†çš„æ¨è¿›æ„Ÿæ›²çº¿ */
  }

  .ef-rail {
    position: absolute;
    top: 0; left: 0;
    width: 14px;
    height: 100%;
    background: rgba(255, 255, 255, 0.05);
    z-index: 5;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .ef-fill {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 0%;
    background: #FF6B35;
    box-shadow: 0 0 15px rgba(255, 107, 53, 0.8);
    transition: height 0.05s linear;
  }

  .ef-pct-container {
    position: absolute;
    top: 100px; 
    left: 28px;
    transform: translateY(-50%); 
    transition: top 0.05s linear;
    z-index: 5;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    will-change: top;
  }

  .ef-pct-line-v {
    width: 4px; height: 24px; background: #FF6B35;
    margin-left: 4px; margin-bottom: 4px;
    box-shadow: 0 0 8px rgba(255, 107, 53, 0.8);
  }

  .ef-pct-num {
    font-size: 54px; font-weight: 800; color: #FF6B35;
    letter-spacing: 2px; text-shadow: 0 0 15px rgba(255, 107, 53, 0.6);
    line-height: 0.9;
  }

  .ef-pct-subtext {
    font-size: 14px; color: #FF6B35; font-weight: 700;
    letter-spacing: 4px; margin-top: 6px; margin-left: 4px; opacity: 0.9;
  }

  .ef-bg-text {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 4vw; color: rgba(255, 255, 255, 0.02);
    font-weight: 900;
    letter-spacing: 20px;
    pointer-events: none; white-space: nowrap; user-select: none;
  }
</style>

<script nonce="{{nonce}}">
(function () {
  "use strict";

  const originalBg = document.documentElement.style.backgroundColor;
  document.documentElement.style.backgroundColor = "#12151A";

  const LOADER_ID = "endfield-loader";

  if (window.__efLoaderInterval) {
    clearInterval(window.__efLoaderInterval);
    window.__efLoaderInterval = null;
  }

  function clamp(v, min, max) {
    return Math.max(min, Math.min(max, v));
  }

  function ensureLoaderDom() {
    let loader = document.getElementById(LOADER_ID);
    if (loader) return loader;

    document.body.insertAdjacentHTML("beforeend", `
      <div id="endfield-loader">
        <div id="ef-orange-flash"></div>
        <div class="ef-bg-text">ENDFIELD INITIALIZING</div>

        <div class="ef-rail">
          <div class="ef-fill" id="ef-bar"></div>
        </div>

        <div class="ef-pct-container" id="ef-pct-box">
          <div class="ef-pct-line-v"></div>
          <div class="ef-pct-num" id="ef-pct">0%</div>
          <div class="ef-pct-subtext" id="ef-text">LOADING...</div>
        </div>
      </div>
    `);

    return document.getElementById(LOADER_ID);
  }

  function start() {
    const loader = ensureLoaderDom();
    const orangeFlash = document.getElementById("ef-orange-flash");
    const bar = document.getElementById("ef-bar");
    const pctBox = document.getElementById("ef-pct-box");
    const pctText = document.getElementById("ef-pct");
    const subText = document.getElementById("ef-text");

    if (!loader || !bar || !pctBox || !pctText) return;

    let pct = 0;
    let isFinishing = false;

    function updatePctBoxPosition(pctValue) {
      const vh = loader.getBoundingClientRect().height || window.innerHeight;
      let centerY = (pctValue / 100) * vh;

      // ä¿åº•ç•Œé™ï¼Œé˜²æ­¢å­—ä½“æœªåŠ è½½æ—¶æ’ç ´å±å¹•è¾¹ç¼˜
      if (centerY < 100) centerY = 100;
      if (centerY > vh - 100) centerY = vh - 100;

      pctBox.style.top = centerY + "px";
    }

    function render() {
      bar.style.height = pct + "%";
      pctText.textContent = pct + "%";
      updatePctBoxPosition(pct);
    }

    render();

    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(render).catch(function(){});
    }

    window.addEventListener("resize", render, { passive: true });

    window.__efLoaderInterval = setInterval(() => {
      if (!isFinishing) {
        pct += Math.floor(Math.random() * 4) + 1;
        if (pct >= 85) pct = 85;
      } else {
        pct += 8;
        if (pct >= 100) {
          pct = 100;
          render();
          clearInterval(window.__efLoaderInterval);
          window.__efLoaderInterval = null;
          triggerOutro();
          return;
        }
      }
      render();
    }, 40);

    // ==========================================
    // ğŸš‘ æ ¸å¿ƒä¿®å¤ï¼šæŠŠä¸¢å¤±çš„é€šè®¯å‡½æ•°åŠ å›æ¥ï¼
    // ==========================================
    window.efFinishLoading = function () {
      if (isFinishing) return;
      isFinishing = true;
      if (subText) subText.textContent = "SYSTEM READY";
    };

    function triggerOutro() {
      setTimeout(() => {
        // è§¦å‘ç‰©ç†æ¨ªæ‰«
        if (orangeFlash) orangeFlash.style.transform = "scaleX(1)";
        
        document.documentElement.style.backgroundColor = originalBg;
        
        // ç•™è¶³ 250ms è®©æ©™è‰²é—ªå…‰æ‰«è¿‡å…¨å±ï¼Œç„¶åæ•´ä¸ªç•Œé¢æ·¡å‡º
        setTimeout(() => {
          loader.style.opacity = "0";
          loader.style.pointerEvents = "none";
          setTimeout(() => loader.remove(), 600);
        }, 250); 
      }, 50);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", start, { once: true });
  } else {
    start();
  }
})();
</script>
