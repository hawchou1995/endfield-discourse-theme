<style>
  /*
    Discourse Route/Global Spinner Killer
    - Critical CSS: 尽早防闪现
    - 只针对“疑似全局/路由”区域，尽量不影响按钮内 spinner
  */

  :root.__ef_kill_route_spinner
    body > .spinner,
  :root.__ef_kill_route_spinner
    #discourse-root > .spinner,
  :root.__ef_kill_route_spinner
    .d-app-body > .spinner,
  :root.__ef_kill_route_spinner
    #main-outlet .spinner,
  :root.__ef_kill_route_spinner
    #main-outlet-wrapper .spinner,
  :root.__ef_kill_route_spinner
    #main .spinner,
  :root.__ef_kill_route_spinner
    #main-outlet .bouncing-dots,
  :root.__ef_kill_route_spinner
    #main-outlet-wrapper .bouncing-dots,
  :root.__ef_kill_route_spinner
    #main .bouncing-dots,
  :root.__ef_kill_route_spinner
    #global-spinner,
  :root.__ef_kill_route_spinner
    #global-loading-spinner,
  :root.__ef_kill_route_spinner
    .global-spinner,
  :root.__ef_kill_route_spinner
    .route-spinner,
  :root.__ef_kill_route_spinner
    .spinner-container {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    animation: none !important;
  }

  /* 白名单豁免：按钮/表单控件里的 spinner 要保留 */
  :root.__ef_kill_route_spinner .btn .spinner,
  :root.__ef_kill_route_spinner .btn .bouncing-dots,
  :root.__ef_kill_route_spinner button .spinner,
  :root.__ef_kill_route_spinner button .bouncing-dots,
  :root.__ef_kill_route_spinner .d-button .spinner,
  :root.__ef_kill_route_spinner .d-button .bouncing-dots,
  :root.__ef_kill_route_spinner .select-kit .spinner,
  :root.__ef_kill_route_spinner .select-kit .bouncing-dots,
  :root.__ef_kill_route_spinner .combo-box .spinner,
  :root.__ef_kill_route_spinner .combo-box .bouncing-dots,
  :root.__ef_kill_route_spinner .input-group .spinner,
  :root.__ef_kill_route_spinner .input-group .bouncing-dots {
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
</style>

<script nonce="{{nonce}}">
(function () {
  "use strict";

  // 0) 尽早启用 critical CSS（防闪现）
  document.documentElement.classList.add("__ef_kill_route_spinner");

  // 1) 防重复注册（主题热更新/多次注入时很常见）
  if (window.__EF_ROUTE_SPINNER_KILLER__) return;
  window.__EF_ROUTE_SPINNER_KILLER__ = true;

  // 2) 可选：调试开关（控制台执行 window.__EF_KILL_SPINNER_DEBUG = true）
  function debugLog(...args) {
    if (window.__EF_KILL_SPINNER_DEBUG) console.log("[RouteSpinnerKiller]", ...args);
  }

  // 3) 选择器集合：覆盖 Discourse 常见 spinner 命名 + “三点”
  const SPINNER_SELECTOR = [
    "#global-loading-spinner",
    "#global-spinner",
    ".global-spinner",
    ".route-spinner",
    ".spinner-container",
    ".spinner",
    ".bouncing-dots"
  ].join(",");

  // 4) 白名单：在这些容器/控件里发现 spinner，不杀（避免按钮无反馈）
  const WHITELIST_CLOSEST = [
    "button",
    ".btn",
    ".d-button",
    ".select-kit",
    ".combo-box",
    ".input-group",
    ".d-modal",          // 弹窗里可能有真实 loading
    ".composer-popup",   // 编辑器相关
    ".composer-container"
  ].join(",");

  // 5) 我们主要“治理”的范围：路由/主 outlet 附近（降低误伤）
  const ROUTE_SCOPE_CLOSEST = [
    "#main-outlet",
    "#main-outlet-wrapper",
    "#main",
    "#discourse-root",
    ".d-app-body"
  ].join(",");

  function shouldKill(el) {
    if (!el || el.nodeType !== 1) return false;

    // 已处理过的别再碰（防抖 + 性能）
    if (el.dataset && el.dataset.efKilledSpinner === "1") return false;

    // 只处理“像 spinner 的东西”
    if (!el.matches(SPINNER_SELECTOR)) return false;

    // 在白名单控件里 -> 放过
    if (el.closest(WHITELIST_CLOSEST)) return false;

    // 必须处在路由/主区域附近 -> 才认为是“全局/路由 spinner”
    if (!el.closest(ROUTE_SCOPE_CLOSEST) && el.parentElement !== document.body) return false;

    return true;
  }

  function kill(el, reason) {
    try {
      if (!el || el.nodeType !== 1) return;

      // 标记，避免重复处理
      if (el.dataset) el.dataset.efKilledSpinner = "1";

      // 用隐藏而非 remove：更安全，便于回退/减少副作用
      el.style.setProperty("display", "none", "important");
      el.style.setProperty("opacity", "0", "important");
      el.style.setProperty("visibility", "hidden", "important");
      el.style.setProperty("animation", "none", "important");

      debugLog("killed:", reason, el);
    } catch (e) {
      // 零信任：任何 DOM 操作都可能抛异常（比如节点被瞬间移除）
    }
  }

  function scanAndKill(root, reason) {
    if (!root || root.nodeType !== 1) return;

    // root 自己是 spinner
    if (root.matches && root.matches(SPINNER_SELECTOR) && shouldKill(root)) {
      kill(root, reason);
      return;
    }

    // root 子树里有 spinner
    const list = root.querySelectorAll ? root.querySelectorAll(SPINNER_SELECTOR) : [];
    for (const el of list) {
      if (shouldKill(el)) kill(el, reason);
    }
  }

  // 6) 首次全量扫描：解决“已存在”的复活/残留
  const initialScan = () => {
    scanAndKill(document.documentElement, "initial-scan");
  };

  // 7) MutationObserver：解决“死而复生”
  const obs = new MutationObserver((mutations) => {
    for (const m of mutations) {
      for (const n of m.addedNodes) {
        if (n && n.nodeType === 1) scanAndKill(n, "mutation");
      }
    }
  });

  function startObserver() {
    if (!document.body) return;

    initialScan();

    obs.observe(document.body, { childList: true, subtree: true });
    debugLog("observer started");
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", startObserver, { once: true });
  } else {
    startObserver();
  }

  // 8) 内置验证点（可在控制台手动调用）
  window.__EF_TEST_ROUTE_SPINNER_KILLER__ = function () {
    const demo = document.createElement("div");
    demo.innerHTML = '<div class="spinner"><div class="bouncing-dots"><div></div><div></div><div></div></div></div>';
    (document.querySelector("#main-outlet") || document.body).appendChild(demo);
    debugLog("test inserted demo spinner into outlet");
  };
})();
</script>
